#!/bin/bash
# Claude Code YOLO mode - auto-approve all actions in containerized environment

set -e

# Parse arguments: everything before -- goes to podman, everything after goes to claude
# Also check for --anonymized-paths and --entrypoint flags
PODMAN_ARGS=()
CLAUDE_ARGS=()
found_separator=0
USE_ANONYMIZED_PATHS=0
ENTRYPOINT="claude"

while [ $# -gt 0 ]; do
    case "$1" in
        --entrypoint)
            ENTRYPOINT="$2"
            shift 2
            ;;
        --entrypoint=*)
            ENTRYPOINT="${1#--entrypoint=}"
            shift
            ;;
        --anonymized-paths)
            USE_ANONYMIZED_PATHS=1
            shift
            ;;
        --)
            shift
            found_separator=1
            CLAUDE_ARGS=("$@")
            break
            ;;
        *)
            if [ "$found_separator" -eq 1 ]; then
                CLAUDE_ARGS+=("$1")
            else
                PODMAN_ARGS+=("$1")
            fi
            shift
            ;;
    esac
done

if [ "$found_separator" = 0 ]; then
    # so we did not find any -- everything is actually CLAUDE_ARGS
    CLAUDE_ARGS=("${PODMAN_ARGS[@]}")
    PODMAN_ARGS=()
fi

# Give a meaningful name based on PWD and the PID to help identifying
# all those podman containers
name=$( echo "$PWD-$$" | sed -e "s,^$HOME/,,g" -e "s,[^a-zA-Z0-9_.-],_,g" )

CLAUDE_HOME_DIR="$HOME/.claude"
# must exist but might not if first start on that box
mkdir -p "$CLAUDE_HOME_DIR"

# Determine paths based on --anonymized-paths flag
if [ "$USE_ANONYMIZED_PATHS" -eq 1 ]; then
    # Old behavior: use anonymized paths
    CLAUDE_DIR="/claude"
    WORKSPACE_DIR="/workspace"
    CLAUDE_MOUNT="$CLAUDE_HOME_DIR:/claude:Z"
    WORKSPACE_MOUNT="$(pwd):/workspace:Z"
else
    # New default behavior: preserve original host paths
    CLAUDE_DIR="$CLAUDE_HOME_DIR"
    WORKSPACE_DIR="$(pwd)"
    CLAUDE_MOUNT="$CLAUDE_HOME_DIR:$CLAUDE_HOME_DIR:Z"
    WORKSPACE_MOUNT="$(pwd):$(pwd):Z"
fi

# Build the command to run inside the container
if [ "$ENTRYPOINT" = "claude" ]; then
    # Default: run claude with --dangerously-skip-permissions
    CONTAINER_CMD=("claude" "--dangerously-skip-permissions" "${CLAUDE_ARGS[@]}")
else
    # Custom entrypoint: run as-is with any additional args
    CONTAINER_CMD=("$ENTRYPOINT" "${CLAUDE_ARGS[@]}")
fi

podman run -it --rm \
    --user="$(id -u):$(id -g)"\
    --userns=keep-id \
    --name="$name" \
    -v "$CLAUDE_MOUNT" \
    -v "$HOME/.gitconfig:/tmp/.gitconfig:ro,Z" \
    -v "$WORKSPACE_MOUNT" \
    -w "$WORKSPACE_DIR" \
    -e CLAUDE_CONFIG_DIR="$CLAUDE_DIR" \
    -e GIT_CONFIG_GLOBAL=/tmp/.gitconfig \
    "${PODMAN_ARGS[@]}" \
    con-bomination-claude-code \
    "${CONTAINER_CMD[@]}"
