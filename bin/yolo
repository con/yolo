#!/bin/bash
# Claude Code YOLO mode - auto-approve all actions in containerized environment

set -e

# Parse arguments: everything before -- goes to podman, everything after goes to claude
# Also check for --global-claude flag
PODMAN_ARGS=()
CLAUDE_ARGS=()
found_separator=0
USE_GLOBAL_CLAUDE=0

for arg in "$@"; do
    if [ "$arg" = "--global-claude" ]; then
        USE_GLOBAL_CLAUDE=1
    elif [ "$found_separator" -eq 0 ] && [ "$arg" = "--" ]; then
        found_separator=1
    elif [ "$found_separator" -eq 1 ]; then
        CLAUDE_ARGS+=("$arg")
    else
        PODMAN_ARGS+=("$arg")
    fi
done

if [ "$found_separator" = 0 ]; then
    # so we did not find any -- everything is actually CLAUDE_ARGS
    CLAUDE_ARGS=("${PODMAN_ARGS[@]}")
    PODMAN_ARGS=()
fi

# Give a meaningful name based on PWD and the PID to help identifying
# all those podman containers
name=$( echo "$PWD-$$" | sed -e "s,^$HOME/,,g" -e "s,[^a-zA-Z0-9_.-],_,g" )

# Determine paths based on --global-claude flag
if [ "$USE_GLOBAL_CLAUDE" -eq 1 ]; then
    # Old behavior: use anonymized paths
    CLAUDE_DIR="/claude"
    WORKSPACE_DIR="/workspace"
    CLAUDE_MOUNT="$HOME/.claude:/claude:Z"
    WORKSPACE_MOUNT="$(pwd):/workspace:Z"
else
    # New default behavior: preserve original host paths
    CLAUDE_DIR="$HOME/.claude"
    WORKSPACE_DIR="$(pwd)"
    CLAUDE_MOUNT="$HOME/.claude:$HOME/.claude:Z"
    WORKSPACE_MOUNT="$(pwd):$(pwd):Z"
fi

podman run -it --rm \
    --user="$(id -u):$(id -g)"\
    --userns=keep-id \
    --name="$name" \
    -v "$CLAUDE_MOUNT" \
    -v "$HOME/.gitconfig:/tmp/.gitconfig:ro,Z" \
    -v "$WORKSPACE_MOUNT" \
    -w "$WORKSPACE_DIR" \
    -e CLAUDE_CONFIG_DIR="$CLAUDE_DIR" \
    -e GIT_CONFIG_GLOBAL=/tmp/.gitconfig \
    "${PODMAN_ARGS[@]}" \
    con-bomination-claude-code \
    claude --dangerously-skip-permissions "${CLAUDE_ARGS[@]}"
