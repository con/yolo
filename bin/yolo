#!/bin/bash
# Claude Code YOLO mode - auto-approve all actions in containerized environment

set -e

# Parse arguments: everything before -- goes to podman, everything after goes to claude
PODMAN_ARGS=()
CLAUDE_ARGS=()
found_separator=0

for arg in "$@"; do
    if [ "$found_separator" -eq 0 ] && [ "${arg:0:2}" = "--" ]; then
        found_separator=1
    elif [ "$found_separator" -eq 1 ]; then
        CLAUDE_ARGS+=("$arg")
    else
        PODMAN_ARGS+=("$arg")
    fi
done

if [ "$found_separator" = 0 ]; then
    # so we did not find any -- everything is actually CLAUDE_ARGS
    CLAUDE_ARGS=("${PODMAN_ARGS[@]}")
    PODMAN_ARGS=()
fi

# Give a meaningful name based on PWD and the PID to help identifying
# all those podman containers
name=$( echo "$PWD-$$" | sed -e "s,^$HOME/,,g" -e "s,[^a-zA-Z0-9_.-],_,g" )

podman run -it --rm \
    --user="$(id -u):$(id -g)"\
    --userns=keep-id \
    --name="$name" \
    -v "$HOME/.claude:/claude:Z" \
    -v "$HOME/.gitconfig:/tmp/.gitconfig:ro,Z" \
    -v "$(pwd):/workspace:Z" \
    -w /workspace \
    -e CLAUDE_CONFIG_DIR=/claude \
    -e GIT_CONFIG_GLOBAL=/tmp/.gitconfig \
    "${PODMAN_ARGS[@]}" \
    con-bomination-claude-code \
    claude --dangerously-skip-permissions "${CLAUDE_ARGS[@]}"
