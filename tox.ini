[tox]
envlist = shellcheck,bats,docker-build
skipsdist = true

[testenv:shellcheck]
description = Run shellcheck on shell scripts
deps =
skip_install = true
allowlist_externals =
    shellcheck
    find
commands =
    shellcheck --version
    shellcheck setup-yolo.sh
    shellcheck bin/yolo

[testenv:bats]
description = Run BATS tests for setup and yolo scripts
deps =
skip_install = true
allowlist_externals =
    bats
    bash
    mkdir
    rm
commands =
    bats --version
    bats tests/setup-yolo.bats
    bats tests/yolo.bats

[testenv:docker-build]
description = Test Docker image construction
deps =
skip_install = true
allowlist_externals =
    podman
    docker
    bash
commands_pre =
    bash -c 'command -v podman || command -v docker'
commands =
    # Test that Dockerfile is valid and can be parsed
    bash -c 'if command -v podman &> /dev/null; then podman build --help > /dev/null; else docker build --help > /dev/null; fi'

    # Validate Dockerfile syntax by attempting a dry-run build context check
    bash -c 'if command -v podman &> /dev/null; then podman build -f images/Dockerfile --layers=false -t con-bomination-claude-code-test images/ || exit 0; else docker build -f images/Dockerfile -t con-bomination-claude-code-test images/ || exit 0; fi'

[testenv:docker-build-full]
description = Full Docker image build (may take several minutes)
deps =
skip_install = true
allowlist_externals =
    podman
    docker
    bash
    timedatectl
commands =
    # Perform a full image build to verify everything works
    bash -c 'TZ=$(timedatectl show --property=Timezone --value 2>/dev/null || echo "UTC"); if command -v podman &> /dev/null; then podman build --build-arg "TZ=$TZ" -t con-bomination-claude-code-test-full images/; else docker build --build-arg "TZ=$TZ" -t con-bomination-claude-code-test-full images/; fi'

[testenv:integration]
description = Run integration tests (requires built image)
deps =
skip_install = true
allowlist_externals =
    bash
    podman
    docker
commands =
    # Test that the image can be started
    bash -c 'if command -v podman &> /dev/null; then podman run --rm con-bomination-claude-code-test-full claude --version; else docker run --rm con-bomination-claude-code-test-full claude --version; fi'

[testenv]
description = Run all tests (shellcheck + bats + docker build check)
deps =
skip_install = true
allowlist_externals =
    {[testenv:shellcheck]allowlist_externals}
    {[testenv:bats]allowlist_externals}
    {[testenv:docker-build]allowlist_externals}
commands =
    {[testenv:shellcheck]commands}
    {[testenv:bats]commands}
    {[testenv:docker-build]commands}
